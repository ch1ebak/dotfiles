#+TITLE: ch1ebak's cool emacs config 2: electric boogaloo
#+AUTHOR: ch1ebak

* STARTUP PERFORMANCE
#+begin_src emacs-lisp
;; The default is 800 kilobytes.  Measured in bytes.
(setq gc-cons-threshold (* 50 1000 1000))

(defun efs/display-startup-time ()
  (message "Emacs loaded in %s with %d garbage collections."
           (format "%.2f seconds"
                   (float-time
                     (time-subtract after-init-time before-init-time)))
           gcs-done))

(add-hook 'emacs-startup-hook #'efs/display-startup-time)
#+end_src

* [[https://github.com/progfolio/elpaca][ELPACA]]
#+begin_src emacs-lisp
    (defvar elpaca-installer-version 0.7)
    (defvar elpaca-directory (expand-file-name "elpaca/" user-emacs-directory))
    (defvar elpaca-builds-directory (expand-file-name "builds/" elpaca-directory))
    (defvar elpaca-repos-directory (expand-file-name "repos/" elpaca-directory))
    (defvar elpaca-order '(elpaca :repo "https://github.com/progfolio/elpaca.git"
				  :ref nil :depth 1
				  :files (:defaults "elpaca-test.el" (:exclude "extensions"))
				  :build (:not elpaca--activate-package)))
    (let* ((repo  (expand-file-name "elpaca/" elpaca-repos-directory))
	   (build (expand-file-name "elpaca/" elpaca-builds-directory))
	   (order (cdr elpaca-order))
	   (default-directory repo))
      (add-to-list 'load-path (if (file-exists-p build) build repo))
      (unless (file-exists-p repo)
	(make-directory repo t)
	(when (< emacs-major-version 28) (require 'subr-x))
	(condition-case-unless-debug err
	    (if-let ((buffer (pop-to-buffer-same-window "*elpaca-bootstrap*"))
		     ((zerop (apply #'call-process `("git" nil ,buffer t "clone"
						     ,@(when-let ((depth (plist-get order :depth)))
							 (list (format "--depth=%d" depth) "--no-single-branch"))
						     ,(plist-get order :repo) ,repo))))
		     ((zerop (call-process "git" nil buffer t "checkout"
					   (or (plist-get order :ref) "--"))))
		     (emacs (concat invocation-directory invocation-name))
		     ((zerop (call-process emacs nil buffer nil "-Q" "-L" "." "--batch"
					   "--eval" "(byte-recompile-directory \".\" 0 'force)")))
		     ((require 'elpaca))
		     ((elpaca-generate-autoloads "elpaca" repo)))
		(progn (message "%s" (buffer-string)) (kill-buffer buffer))
	      (error "%s" (with-current-buffer buffer (buffer-string))))
	  ((error) (warn "%s" err) (delete-directory repo 'recursive))))
      (unless (require 'elpaca-autoloads nil t)
	(require 'elpaca)
	(elpaca-generate-autoloads "elpaca" repo)
	(load "./elpaca-autoloads")))
    (add-hook 'after-init-hook #'elpaca-process-queues)
  (elpaca `(,@elpaca-order))

    ;; Install use-package support
(elpaca elpaca-use-package
  ;; Enable :elpaca use-package keyword.
  (elpaca-use-package-mode)
  ;; Assume :elpaca t unless otherwise specified.
  (setq elpaca-use-package-by-default t))

;; Block until current queue processed.
(elpaca-wait)

;;When installing a package which modifies a form used at the top-level
;;(e.g. a package which adds a use-package key word),
;;use `elpaca-wait' to block until that package has been installed/configured.
;;For example:
;;(use-package general :demand t)
;;(elpaca-wait)
#+end_src

* KEYBINDINGS
#+begin_src emacs-lisp
(global-set-key [escape] 'keyboard-escape-quit)
#+end_src

** [[https://github.com/emacs-evil/evil][Evil Mode]]
#+begin_src emacs-lisp
(use-package evil
    :init
    (setq evil-want-integration t)
    (setq evil-want-keybinding nil)
    (setq evil-vsplit-window-right t)
    (setq evil-split-window-below t)
    (setq evil-undo-system 'undo-redo)
    (evil-mode))

(use-package evil-collection
  :after evil
  :config
  (add-to-list 'evil-collection-mode-list 'help) ;; evilify help mode
  (evil-collection-init))

(with-eval-after-load 'evil-maps
  (define-key evil-motion-state-map (kbd "SPC") nil)
  (define-key evil-motion-state-map (kbd "RET") nil)
  (define-key evil-motion-state-map (kbd "TAB") nil))
(setq org-return-follows-link  t)
#+end_src

** [[https://github.com/noctuid/general.el][General]]
#+begin_src emacs-lisp
(use-package general
  :config
  (general-evil-setup)

  ;; set up 'SPC' as the global leader key
  (general-create-definer me/leader-keys
    :states '(normal insert visual emacs)
    :keymaps 'override
    :prefix "SPC" ;; set leader
    :global-prefix "M-SPC") ;; access leader in insert mode

  (me/leader-keys
    "SPC" '(counsel-M-x :wk "M-x")
    "." '(counsel-find-file :wk "Find file")
    ">" '(dired-jump :wk "Dired")
    "," '(counsel-ibuffer :wk "Ibuffer")
    "<" '(kill-buffer :wk "Kill buffer"))
  
  (me/leader-keys
    "b m" '(bookmark-set :wk "Add to bookmarks")
    "b s" '(bookmark-save :wk "Save bookmarks")
    "RET" '(counsel-bookmark :wk "List bookmarks"))

  (me/leader-keys
    "s b" '(swiper-isearch :wk "Swiper")
    "s l" '(counsel-imenu :wk "Imenu")
    "s r" '(counsel-rg :wk "Grep")
    "s f" '(counsel-fzf :wk "Fuzzy finding"))

  (me/leader-keys
    "c c" '(comment-line :wk "Comment Line")
    "c r" '(comment-or-uncomment-region :wk "Comment Region"))

  (me/leader-keys
    "f p" '((lambda () (interactive) (find-file "~/.config/emacs/config.org")) :wk "Emacs config.org")
    "f P" '((lambda () (interactive) (dired "~/.config/emacs/")) :wk "Emacs directory")
    "f r" '(counsel-recentf :wk "Recent files"))

  (me/leader-keys
    "f u" '(sudo-edit-find-file :wk "Sudo find file")
    "f U" '(sudo-edit :wk "Sudo edit file"))

  (me/leader-keys
    "h t" '(counsel-load-theme :wk "Change theme")
    "h U" '(elpaca-update-all :wk "Update packages")
    "h r r" '((lambda () (interactive) (load-file "~/.config/emacs/init.el") (ignore (elpaca-process-queues))) :wk "Reload emacs config"))

  (me/leader-keys
    "TAB q" '(evil-window-delete :wk "Close window")
    "TAB RET" '(evil-window-vnew :wk "New window")
    "TAB h" '(evil-window-left :wk "Window left")
    "TAB j" '(evil-window-down :wk "Window down")
    "TAB k" '(evil-window-up :wk "Window up")
    "TAB l" '(evil-window-right :wk "Window right")
    "TAB n" '(tab-new :wk "New tab")
    "TAB J" '(tab-next :wk "Next tab")
    "TAB K" '(tab-previous :wk "Previous tab")
    "TAB r" '(tab-rename :wk "Rename tab")
    "TAB H" '(previous-buffer :wk "Buffer previous")
    "TAB L" '(next-buffer :wk "Buffer next"))

  (me/leader-keys
    "A" '(org-agenda :wk "Org Agenda")
    "X" '(org-capture :wk "Org Capture"))

  (me/leader-keys
    "N" '((lambda () (interactive) (find-file "~/Dokumenty/notatki/index-index.org")) :wk "Notes index")
    "n n" '((lambda () (interactive) (counsel-find-file "~/Dokumenty/notatki/")) :wk "Notes folder")
    "E" '(elfeed :wk "Elfeed")
    "P" '(pocket-reader :wk "Pocket")
    "W" '(eww :wk "EWW"))

  (general-nmap
    :keymaps 'org-mode-map
    "m a" 'org-insert-link
    "m A" 'link-hint-copy-link
    "m t" 'org-todo
    "m d" 'org-deadline
    "m s" 'org-schedule
    "m r" 'org-refile
    "m H" 'org-metaleft
    "m L" 'org-metaright
    "m J" 'org-down
    "m K" 'org-up
    "M" 'org-sidebar-tree-toggle)
  
  (general-nmap
    :keymaps 'dired-mode-map
    "h" 'dired-up-directory
    "l" 'dired-open-file)
  
  (general-nmap
    :keymaps 'elfeed-mode-map
    "W" 'elfeed-search-browse-url
    "M" 'elfeed-mark-all-as-read
    "O" 'elfeed-update)
)
#+end_src

* MODULES
** [[https://github.com/domtronn/all-the-icons.el][All the Icons]]
#+begin_src emacs-lisp
(use-package all-the-icons
  :ensure t
  :if (display-graphic-p))
#+end_src

** [[https://github.com/Malabarba/beacon][Beacon]]
#+begin_src emacs-lisp
(use-package beacon
  :init
  (beacon-mode 1))
#+end_src

** Dired
#+begin_src emacs-lisp
(use-package dired
  :ensure nil
  :commands (dired dired-jump)
  :custom ((dired-listing-switches "-agho --group-directories-first")))

(setq delete-by-moving-to-trash t
      trash-directory "~/.local/share/Trash/files/")
#+end_src

*** Dired Icons
#+begin_src emacs-lisp
(use-package all-the-icons-dired
  :hook (dired-mode . (lambda () (all-the-icons-dired-mode t))))
#+end_src

*** Dired Open
#+begin_src emacs-lisp
(use-package dired-open
  :config
  (setq dired-open-extensions '(("gif" . "nsxiv")
                                ("jpg" . "nsxiv")
                                ("png" . "nsxiv")
                                ("mkv" . "mpv")
                                ("mp4" . "mpv"))))
#+end_src

*** [[https://github.com/protesilaos/dired-preview][Dired Preview]]
#+begin_src emacs-lisp
(use-package dired-preview
  :config
  (setq dired-preview-delay 0.7)
  (setq dired-preview-max-size (expt 2 20))
  (setq dired-preview-ignored-extensions-regexp
        (concat "\\."
                "\\(mkv\\|webm\\|mp4\\|mp3\\|ogg\\|m4a"
                "\\|gz\\|zst\\|tar\\|xz\\|rar\\|zip"
                "\\|iso\\|epub\\|pdf\\)"))
  (dired-preview-global-mode 1))
#+end_src

** [[https://github.com/skeeto/elfeed][Elfeed]]
#+begin_src emacs-lisp
(use-package elfeed
  :config
  (setq elfeed-search-feed-face ":foreground #ffffff :weight bold")
  (setq elfeed-db-directory "~/.config/emacs/files/elfeed/database"))

(defun elfeed-mark-all-as-read ()
  (interactive)
  (elfeed-untag elfeed-search-entries 'unread)
  (elfeed-search-update :force)) ; redraw
#+end_src

*** [[https://github.com/jeetelongname/elfeed-goodies][Elfeed Goodies]]
#+begin_src emacs-lisp
(use-package elfeed-goodies
  :init
  (elfeed-goodies/setup)
  :config
  (setq elfeed-goodies/entry-pane-size 0.5))
#+end_src

*** [[https://github.com/remyhonig/elfeed-org][Elfeed-org]]
#+begin_src emacs-lisp
(use-package elfeed-org
  :ensure t
  :config
  (setq rmh-elfeed-org-files (list "~/.config/emacs/files/elfeed/elfeed.org"))
  (elfeed-org))
#+end_src

** [[https://github.com/iqbalansari/emacs-emojify][Emojify]] 
#+begin_src emacs-lisp
(use-package emojify
  :hook (after-init . global-emojify-mode))
#+end_src

** ERC
#+begin_src emacs-lisp
(setq erc-prompt (lambda () (concat "[" (buffer-name) "]"))
      erc-server "irc.libera.chat"
      erc-nick "papaemeritusIV"
      erc-track-shorten-start 24
      erc-autojoin-channels-alist '(("irc.libera.chat" "#archlinux" "#linux" "#emacs"))
      erc-kill-buffer-on-part t
      erc-fill-column 100
      erc-fill-function 'erc-fill-static
      erc-fill-static-center 20
      )
#+end_src

** [[https://github.com/edkolev/evil-goggles][Evil Goggles]]
#+begin_src emacs-lisp
(use-package evil-goggles
  :ensure t
  :config
  (evil-goggles-mode))
  ;; (evil-goggles-use-diff-faces)
#+end_src

** EWW
#+begin_src emacs-lisp
(setq
 browse-url-browser-function 'eww-browse-url
 shr-use-fonts  nil
 ;; shr-use-colors nil
 shr-indentation 2
 shr-width 70
 eww-auto-rename-buffer 1
 eww-download-directory "~/Pobrane"
 eww-search-prefix "https://frogfind.com/?q="
 browse-url-secondary-browser-function 'browse-url-firefox)

(add-hook 'eww-after-render-hook 'eww-readable)

(defun eww-new ()
  (interactive)
  (let ((url (read-from-minibuffer "Enter URL or keywords: ")))
    (switch-to-buffer (generate-new-buffer "eww"))
    (eww-mode)
    (eww url)))
#+end_src

** [[https://github.com/flycheck/flycheck][Flycheck]]
#+begin_src emacs-lisp
(use-package flycheck
  :ensure t
  :defer t
  :diminish
  :init (global-flycheck-mode))
#+end_src

** [[https://github.com/tarsius/hl-todo][Highlight TODO]]
#+begin_src emacs-lisp
(use-package hl-todo
  :hook ((org-mode . hl-todo-mode)
         (prog-mode . hl-todo-mode))
  :config
  (setq hl-todo-highlight-punctuation ":"
        hl-todo-keyword-faces
        `(("TODO"       warning bold)
          ("FIXME"      error bold)
          ("HACK"       font-lock-constant-face bold)
          ("REVIEW"     font-lock-keyword-face bold)
          ("NOTE"       success bold)
          ("DEPRECATED" font-lock-doc-face bold))))
#+end_src

** [[https://github.com/abo-abo/swiper][Ivy]]
#+begin_src emacs-lisp
(use-package counsel
  :after ivy
  :diminish
  :config 
    (counsel-mode)
    (setq ivy-initial-inputs-alist nil)) ;; removes starting ^ regex in M-x

(use-package ivy
  :bind
     (:map ivy-minibuffer-map
     ("TAB" . ivy-alt-done)
     ("C-l" . ivy-alt-done)
     ("C-j" . ivy-next-line)
     ("C-k" . ivy-previous-line)
     :map ivy-switch-buffer-map
     ("C-k" . ivy-previous-line)
     ("C-l" . ivy-done)
     ("C-d" . ivy-switch-buffer-kill)
     :map ivy-reverse-i-search-map
     ("C-k" . ivy-previous-line)
     ("C-d" . ivy-reverse-i-search-kill))
  :diminish
  :custom
    (setq ivy-use-virtual-buffers t)
    (setq ivy-count-format "(%d/%d) ")
    (setq enable-recursive-minibuffers t)
  :config
    (ivy-mode))
#+end_src

*** [[https://github.com/seagle0128/all-the-icons-ivy-rich][Ivy Icons]]
#+begin_src emacs-lisp
(use-package all-the-icons-ivy-rich
  :ensure t
  :init (all-the-icons-ivy-rich-mode 1))
#+end_src

*** [[https://github.com/radian-software/prescient.el][Ivy Prescient]]
#+begin_src emacs-lisp
(use-package ivy-prescient
  :after counsel
  :custom
    (ivy-prescient-enable-filtering nil)
  :config
    (prescient-persist-mode 1)
    (ivy-prescient-mode 1))
#+end_src

*** [[https://github.com/Yevgnen/ivy-rich][Ivy Rich]]
#+begin_src emacs-lisp
(use-package ivy-rich
  :after ivy
  :ensure t
  :init (ivy-rich-mode 1) ;; this gets us descriptions in M-x.
  :custom
  (ivy-virtual-abbreviate 'full
   ivy-rich-switch-buffer-align-virtual-buffer t
   ivy-rich-path-style 'abbrev)
  :config
  (ivy-set-display-transformer 'ivy-switch-buffer
                               'ivy-rich-switch-buffer-transformer))
#+end_src

** Org-mode
#+begin_src emacs-lisp
(setq org-ellipsis " ▾")

(setq org-agenda-start-with-log-mode t)
(setq org-log-done 'time)
(setq org-log-into-drawer t)

;; (setq org-agenda-files '("~/Dokumenty/notatki/agenda/"))
(setq org-agenda-files
  '("~/Dokumenty/notatki/agenda/agenda-agenda.org"
    "~/Dokumenty/notatki/agenda/agenda-habits.org"
    "~/Dokumenty/notatki/agenda/agenda-important.org"))


(setq org-todo-keywords
  '((sequence "TODO(t)" "WAIT(w)" "|" "CANCELED(c)" "DONE(d)")))

(setq org-src-preserve-indentation t)

(setq calendar-week-start-day 1)
#+end_src

*** [[https://github.com/sabof/org-bullets][Org Bullets]]
#+begin_src emacs-lisp
(add-hook 'org-mode-hook 'org-indent-mode)
(use-package org-bullets)
(add-hook 'org-mode-hook (lambda () (org-bullets-mode 1)))
#+end_src

*** Org Capture
#+begin_src emacs-lisp
(setq org-capture-templates
      '(("t" "Todo" entry (file+headline "~/Dokumenty/notatki/agenda/agenda-agenda.org" "TODOs")
         "* TODO %?\n  %i\n  %a")))
#+end_src

*** Org Habit
#+begin_src emacs-lisp
(require 'org-habit)
(add-to-list 'org-modules 'org-habit)
(setq org-habit-graph-column 60)
#+end_src

*** Org Refile
#+begin_src emacs-lisp
(setq org-refile-targets
  '(("archive.org" :maxlevel . 1)))
(advice-add 'org-refile :after 'org-save-all-org-buffers)
#+end_src

*** [[https://github.com/alphapapa/org-sidebar][Org Sidebar]]
#+begin_src emacs-lisp
(use-package org-sidebar)
#+end_src

*** Org Tempo
#+begin_src emacs-lisp
(require 'org-tempo)
#+end_src

*** [[https://github.com/ofosos/ox-epub][Ox-Epub]] 
#+begin_src emacs-lisp
(use-package ox-epub)
#+end_src

** [[https://github.com/alphapapa/pocket-reader.el][Pocket Reader]]
#+begin_src emacs-lisp
(use-package pocket-reader)
;; (setq pocket-reader-open-url-default-function #'eww)
;; (setq pocket-reader-pop-to-url-default-function #'eww)
;; (add-hook 'pocket-reader-mode (lambda () (display-line-numbers-mode 0)))
#+end_src

** [[https://github.com/Fanael/rainbow-delimiters][Rainbow Delimiters]]
#+begin_src emacs-lisp
(use-package rainbow-delimiters
  :hook ((emacs-lisp-mode . rainbow-delimiters-mode)
         (clojure-mode . rainbow-delimiters-mode)))
#+end_src

** [[https://github.com/emacsmirror/rainbow-mode][Rainbow Mode]]
#+begin_src emacs-lisp
(use-package rainbow-mode
  :diminish
  :hook org-mode prog-mode)
#+end_src

** [[https://github.com/hlissner/emacs-solaire-mode][Solaire Mode]]
#+begin_src emacs-lisp
(use-package solaire-mode
  :init
  (solaire-global-mode +1))
#+end_src

** [[https://github.com/nflath/sudo-edit][Sudo Edit]]
#+begin_src emacs-lisp
(use-package sudo-edit)
#+end_src

** Tab Bar Mode
#+begin_src emacs-lisp
(setq tab-bar-new-tab-choice "*scratch*"
      tab-bar-close-button-show nil
      tab-bar-new-button-show nil
      tab-bar-show 1)
#+end_src

** [[https://github.com/justbur/emacs-which-key][Which Key]]
#+begin_src emacs-lisp
(use-package which-key
  :init
    (which-key-mode 1)
  :diminish
  :config
  (setq which-key-side-window-location 'bottom
	  which-key-sort-order #'which-key-key-order-alpha
	  which-key-allow-imprecise-window-fit nil
	  which-key-sort-uppercase-first nil
	  which-key-add-column-padding 1
	  which-key-max-display-columns nil
	  which-key-min-display-lines 6
	  which-key-side-window-slot -10
	  which-key-side-window-max-height 0.25
	  which-key-idle-delay 0.8
	  which-key-max-description-length 25
	  which-key-allow-imprecise-window-fit nil
	  which-key-separator " → " ))
#+end_src

* SETTINGS
#+begin_src emacs-lisp
(delete-selection-mode 1)    ;; You can select text and delete it by typing.
(electric-indent-mode -1)    ;; Turn off the weird indenting that Emacs does by default.
(electric-pair-mode 1)       ;; Turns on automatic parens pairing
;; The following prevents <> from auto-pairing when electric-pair-mode is on.
;; Otherwise, org-tempo is broken when you try to <s TAB...
(add-hook 'org-mode-hook (lambda ()
           (setq-local electric-pair-inhibit-predicate
                   `(lambda (c)
                  (if (char-equal c ?<) t (,electric-pair-inhibit-predicate c))))))
(global-auto-revert-mode t)  ;; Automatically show changes if the file has changed
(global-display-line-numbers-mode 1) ;; Display line numbers
(global-visual-line-mode t)  ;; Enable truncated lines
(menu-bar-mode -1)           ;; Disable the menu bar 
(scroll-bar-mode -1)         ;; Disable the scroll bar
(tool-bar-mode -1)           ;; Disable the tool bar
(setq org-edit-src-content-indentation 0) ;; Set src block automatic indent to 0 instead of 2.
(setq use-file-dialog nil)   ;; No file dialog
(setq use-dialog-box nil)    ;; No dialog box
(setq pop-up-windows nil)    ;; No popup windows
(setq inhibit-startup-screen nil)

(setq conf-unix-mode t)
(setq shell-file-name "/usr/bin/bash")
#+end_src

*** Clean-up
#+begin_src emacs-lisp
(setq backup-directory-alist `(("." . ,(expand-file-name "tmp/backups/" user-emacs-directory))))

(make-directory (expand-file-name "tmp/auto-saves/" user-emacs-directory) t)
(setq auto-save-list-file-prefix (expand-file-name "tmp/auto-saves/sessions/" user-emacs-directory)
      auto-save-file-name-transforms `((".*" ,(expand-file-name "tmp/auto-saves/" user-emacs-directory) t)))
#+end_src

*** Files
#+begin_src emacs-lisp
(setq backup-directory-alist '((".*" . "~/.local/share/Trash/files")))
(setq user-emacs-directory "~/.config/emacs")
;; (setq bookmark-default-file "~/.config/emacs/files/bookmarks")
(setq auth-sources '("~/Dokumenty/tajne/.authinfo.gpg"))
#+end_src

*** Recent files
#+begin_src emacs-lisp
(recentf-mode 1)
(setq recentf-max-menu-items 25)
(setq recentf-max-saved-items 25)
#+end_src

** UI
*** Fonts
#+begin_src emacs-lisp
(set-face-attribute 'default nil
  :font "JetBrainsMono NF"
  :height 100
  :weight 'medium)
(set-face-attribute 'variable-pitch nil
  :font "Atkinson Hyperlegible"
  :height 100
  :weight 'medium)
(set-face-attribute 'fixed-pitch nil
  :font "JetBrainsMono NF"
  :height 100
  :weight 'medium)
(set-face-attribute 'font-lock-comment-face nil
  :slant 'italic)
(set-face-attribute 'font-lock-keyword-face nil
  :slant 'italic)
(add-to-list 'default-frame-alist '(font . "JetBrainsMono NF-10"))
#+end_src

*** [[https://github.com/seagle0128/doom-modeline][Modeline]]
#+begin_src emacs-lisp
(use-package doom-modeline
  :ensure t
  :init (doom-modeline-mode 1)
  :config
  (setq doom-modeline-height 30
        doom-modeline-bar-width 5
        doom-modeline-persp-name t
        doom-modeline-persp-icon t))
#+end_src

*** [[https://github.com/doomemacs/themes][Themes]]
#+begin_src emacs-lisp
(use-package doom-themes
  :config
  (setq doom-themes-enable-bold t
        doom-themes-enable-italic t)
  (load-theme 'doom-spacegrey t)
  (doom-themes-org-config))
#+end_src

* RUNTIME PERFORMANCE
#+begin_src emacs-lisp
;; Make gc pauses faster by decreasing the threshold.
(setq gc-cons-threshold (* 2 1000 1000))
#+end_src
